name: ğŸš€ Auto-generate & deploy blog

on:
  # Scheduled: Monday and Thursday at 9:00 UTC
  schedule:
    - cron: '0 9 * * 1'
    - cron: '0 9 * * 4'

  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repo
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2ï¸âƒ£ Enable pnpm
      - name: ğŸ”§ Enable pnpm
        run: corepack enable

      # 3ï¸âƒ£ Setup Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 4ï¸âƒ£ Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: pnpm install --no-frozen-lockfile

      # 5ï¸âƒ£ Generate blog index
      - name: ğŸ“ Generate blog index
        run: node scripts/updateBlogIndex.js

      # 6ï¸âƒ£ Commit updated index.astro if changes exist
      - name: âš™ï¸ Commit updated blog index
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action (Blog Index Generator)"
          git add src/pages/blog/index.astro
          if git diff --staged --quiet; then
            echo "ğŸ“­ No changes to commit"
          else
            git commit -m "ğŸ“ Auto-update blog index - $(date +'%Y-%m-%d')"
            git push origin HEAD
            echo "âœ… Committed updated index.astro"
          fi

      # 7ï¸âƒ£ Build site
      - name: ğŸ—ï¸ Build site
        run: pnpm run build

      # 8ï¸âƒ£ Deploy to Netlify
      - name: ğŸŒ Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './dist'
          production-deploy: true
          netlify-auth-token: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          netlify-site-id: ${{ secrets.NETLIFY_SITE_ID }}
          deploy-message: "ğŸš€ Auto-generated blog index - $(date +'%Y-%m-%d')"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # 9ï¸âƒ£ Summary
      - name: ğŸ“Š Summary
        run: |
          echo "ğŸ“Š Blog auto-generation completed"
          echo "Date: $(date)"
          echo "Check Netlify for the latest deployed site"
